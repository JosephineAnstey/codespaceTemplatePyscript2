<!DOCTYPE html>
<html>
<head>
    <!-- Required for COI -->
    <script src="/mini-coi.js" scope="./"></script>
    <title>WNY Native Garden Planner</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    
    <!-- PyScript 2024.6.1 -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.6.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.6.1/core.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .garden-bed {
            width: 100%;
            height: 500px;
            background: #e8f5e9;
            position: relative;
            border: 3px solid #2e7d32;
            margin: 20px auto;
        }
        .plant {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: help;
            z-index: 1;
            transition: all 0.3s ease;
        }
        .controls {
            padding: 20px;
            text-align: center;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .zone {
            position: absolute;
            opacity: 0.2;
            z-index: 0;
            border-radius: 8px;
        }
        button, select {
            padding: 8px 16px;
            margin: 0 5px;
            background: #2e7d32;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #status {
            margin-top: 10px;
            color: #666;
            font-style: italic;
        }
        .error {
            color: red;
            padding: 10px;
            background: #ffeeee;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h1>Western NY Native Garden Designer</h1>
        <select id="season-filter">
            <option value="all">All Seasons</option>
            <option value="spring">Spring Blooms</option>
            <option value="summer">Summer Blooms</option>
            <option value="fall">Fall Blooms</option>
        </select>
        <button id="randomize">Mingle Plants</button>
        <button id="reset">Reset Layout</button>
        <div id="status">Initializing garden...</div>
        <div id="error" class="error" style="display:none;"></div>
    </div>

    <div class="garden-bed" id="garden-bed"></div>

    <py-config>
        packages = ["numpy"]
        [[fetch]]
        files = ["./mini-coi.js"]
    </py-config>

    <py-script>
        import numpy as np
        from js import document, console
        from pyodide.ffi import create_proxy
        import traceback

        # Debug mode
        import pyodide
        pyodide.debug = True
        

        def update_status(message):
            document.getElementById("status").textContent = message

        def show_error(message):
            error_div = document.getElementById("error")
            error_div.style.display = "block"
            error_div.textContent = message
            console.error(message)

        try:
            update_status("Loading plant data...")

            # Plant database with preferred zones
            plant_types = [
                {
                    "name": "Joe-Pye Weed",
                    "emoji": "üåø",
                    "season": "summer",
                    "height": 7,
                    "count": 3,
                    "zone": {"x": 100, "y": 50, "width": 150, "height": 200},
                    "original_positions": []
                },
                {
                    "name": "Switchgrass",
                    "emoji": "üåæ",
                    "season": "fall",
                    "height": 5,
                    "count": 4,
                    "zone": {"x": 350, "y": 100, "width": 120, "height": 300},
                    "original_positions": []
                },
                {
                    "name": "Cardinal Flower",
                    "emoji": "‚ù§Ô∏è",
                    "season": "summer",
                    "height": 3,
                    "count": 5,
                    "zone": {"x": 100, "y": 300, "width": 200, "height": 150},
                    "original_positions": []
                },
                {
                    "name": "Wild Ginger",
                    "emoji": "üçÇ",
                    "season": "spring",
                    "height": 0.5,
                    "count": 6,
                    "zone": {"x": 30, "y": 400, "width": 120, "height": 80},
                    "original_positions": []
                }
            ]

            def draw_zones():
                try:
                    garden = document.getElementById("garden-bed")
                    for plant in plant_types:
                        zone = document.createElement("div")
                        zone.className = "zone"
                        zone.style.left = f"{plant['zone']['x']}px"
                        zone.style.top = f"{plant['zone']['y']}px"
                        zone.style.width = f"{plant['zone']['width']}px"
                        zone.style.height = f"{plant['zone']['height']}px"
                        zone.style.backgroundColor = (
                            "#81c784" if plant["season"] == "spring" else
                            "#4fc3f7" if plant["season"] == "summer" else
                            "#ffb74d"
                        )
                        garden.appendChild(zone)
                except Exception as e:
                    show_error(f"Zone drawing failed: {str(e)}")
                    raise

            def initialize_positions():
                try:
                    for plant in plant_types:
                        plant["original_positions"] = []
                        for _ in range(plant["count"]):
                            x = plant["zone"]["x"] + np.random.random() * plant["zone"]["width"]
                            y = plant["zone"]["y"] + np.random.random() * plant["zone"]["height"]
                            plant["original_positions"].append({"x": x, "y": y})
                except Exception as e:
                    show_error(f"Position initialization failed: {str(e)}")
                    raise

            def draw_plants(mingle_factor=0.3):
                try:
                    garden = document.getElementById("garden-bed")
                    # Clear existing plants (keep zones)
                    plants = garden.querySelectorAll(".plant")
                    for plant in plants:
                        plant.remove()
                    
                    for plant in plant_types:
                        for i in range(plant["count"]):
                            div = document.createElement("div")
                            div.className = "plant"
                            
                            # Get base position
                            base_x = plant["original_positions"][i]["x"]
                            base_y = plant["original_positions"][i]["y"]
                            
                            # Apply mingling
                            x = base_x + (np.random.random() - 0.5) * plant["zone"]["width"] * mingle_factor
                            y = base_y + (np.random.random() - 0.5) * plant["zone"]["height"] * mingle_factor
                            
                            # Keep within garden bounds
                            x = max(10, min(x, 490))
                            y = max(10, min(y, 490))
                            
                            div.style.left = f"{x}px"
                            div.style.top = f"{y}px"
                            div.style.backgroundColor = (
                                "#81c784" if plant["season"] == "spring" else
                                "#4fc3f7" if plant["season"] == "summer" else
                                "#ffb74d"
                            )
                            div.title = f"{plant['name']}\nHeight: {plant['height']}ft\nBlooms: {plant['season']}"
                            div.textContent = plant["emoji"]
                            garden.appendChild(div)
                except Exception as e:
                    show_error(f"Plant drawing failed: {str(e)}")
                    raise

            def on_filter_change(event=None):
                try:
                    season = event.target.value if event else "all"
                    zones = document.querySelectorAll(".zone")
                    for i, zone in enumerate(zones):
                        zone.style.display = (
                            "block" if season == "all" or plant_types[i]["season"] == season 
                            else "none"
                        )
                    draw_plants()
                    update_status(f"Showing: {season if season != 'all' else 'all seasons'}")
                except Exception as e:
                    show_error(f"Filter change failed: {str(e)}")

            def randomize_plants(event=None):
                try:
                    draw_plants(mingle_factor=0.7)
                    update_status("Plants mingled!")
                except Exception as e:
                    show_error(f"Randomization failed: {str(e)}")

            def reset_layout(event=None):
                try:
                    initialize_positions()
                    draw_plants(mingle_factor=0)
                    update_status("Layout reset to original positions")
                except Exception as e:
                    show_error(f"Reset failed: {str(e)}")

            # Main initialization
            try:
                update_status("Creating garden...")
                
                # Create persistent proxies
                filter_proxy = create_proxy(on_filter_change)
                randomize_proxy = create_proxy(randomize_plants)
                reset_proxy = create_proxy(reset_layout)

                # Initial setup
                initialize_positions()
                draw_zones()
                draw_plants()

                # Connect UI
                document.getElementById("season-filter").addEventListener("change", filter_proxy)
                document.getElementById("randomize").addEventListener("click", randomize_proxy)
                document.getElementById("reset").addEventListener("click", reset_proxy)

                update_status("Ready! Select a season or mingle plants.")
                
            except Exception as e:
                show_error(f"Initialization failed: {str(e)}\n{traceback.format_exc()}")
                raise

        except Exception as e:
            show_error(f"Critical error: {str(e)}\n{traceback.format_exc()}")
    </py-script>
</body>
</html>